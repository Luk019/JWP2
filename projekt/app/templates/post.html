{% extends 'base.html' %}

{% block content %}
    <h1>{{ post.title }}</h1>
    <p>{{ post.content }}</p>
    <div>
        <div>
            {% set upvotes = post.likes|selectattr('upvote')|list|length %}
            {% set downvotes = post.likes|rejectattr('upvote')|list|length %}
            <a href="{{ url_for('main.like_action', entity_id=post.id, entity_type='post', action='upvote') }}" class="{{ 'selected' if post.likes|selectattr('user_id', 'equalto', current_user.id)|selectattr('upvote')|list|length > 0 else '' }}">👍 {{ upvotes }}</a>
            <a href="{{ url_for('main.like_action', entity_id=post.id, entity_type='post', action='downvote') }}" class="{{ 'selected' if post.likes|selectattr('user_id', 'equalto', current_user.id)|rejectattr('upvote')|list|length > 0 else '' }}">👎 {{ downvotes }}</a>
            {% if current_user.is_authenticated and (current_user.id == post.user_id or current_user.is_admin) %}
                <a href="{{ url_for('main.edit_post', post_id=post.id) }}">
                    <img src="{{ url_for('static', filename='img/edit.png') }}" alt="Edit" style="width:20px; height:20px;">
                </a>
                <form action="{{ url_for('main.delete_post', post_id=post.id) }}" method="POST" style="display:inline;">
                    <button type="submit" style="border:none; background:none; cursor:pointer;">
                        <img src="{{ url_for('static', filename='img/delete.png') }}" alt="Delete" style="width:20px; height:20px;">
                    </button>
                </form>
            {% endif %}
        </div>
    </div>
    <div>
        <h2>Comments</h2>
        {% for comment in post.comments %}
            {% if not comment.is_hidden %}
                <div class="comment">
                    <p>{{ comment.content }}</p>
                    <small>{{ comment.date_posted }}</small>
                    <div>
                        {% set upvotes = comment.likes|selectattr('upvote')|list|length %}
                        {% set downvotes = comment.likes|rejectattr('upvote')|list|length %}
                        {% set upvote = comment.likes|selectattr('user_id', 'equalto', current_user.id)|selectattr('upvote')|list|length > 0 %}
                        {% set downvote = comment.likes|selectattr('user_id', 'equalto', current_user.id)|rejectattr('upvote')|list|length > 0 %}
                        <a href="{{ url_for('main.like_action', entity_id=comment.id, entity_type='comment', action='upvote') }}" class="{{ 'selected' if upvote else '' }}">👍 {{ upvotes }}</a>
                        <a href="{{ url_for('main.like_action', entity_id=comment.id, entity_type='comment', action='downvote') }}" class="{{ 'selected' if downvote else '' }}">👎 {{ downvotes }}</a>
                        {% if current_user.is_authenticated and (current_user.id == comment.user_id or current_user.is_admin) %}
                            <a href="{{ url_for('main.edit_comment', comment_id=comment.id) }}">
                                <img src="{{ url_for('static', filename='img/edit.png') }}" alt="Edit" style="width:20px; height:20px;">
                            </a>
                            <form action="{{ url_for('main.delete_comment', comment_id=comment.id) }}" method="POST" style="display:inline;">
                                <button type="submit" style="border:none; background:none; cursor:pointer;">
                                    <img src="{{ url_for('static', filename='img/delete.png') }}" alt="Delete" style="width:20px; height:20px;">
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        {% if current_user.is_authenticated %}
            <form action="{{ url_for('main.post', post_id=post.id) }}" method="POST">
                <textarea name="content" placeholder="Add a comment" required></textarea>
                <button type="submit">Submit</button>
            </form>
        {% else %}
            <p><a href="{{ url_for('auth.login') }}">Log in</a> to comment.</p>
        {% endif %}
    </div>
{% endblock %}
